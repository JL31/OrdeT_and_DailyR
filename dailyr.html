<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DailyR</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="unified_storage.js"></script>
  <style>
    body {
      padding-top: 3.5rem; /* Espace pour la navbar fixe */
    }

    .navbar {
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .section {
      padding: 2rem 1.5rem;
    }

    .group {
      margin: 1.5rem 0;
      border: 1px solid #dbdbdb;
      border-radius: 0.5rem;
      background: white;
    }

    .group.is-collapsed > .group-content {
      display: none;
    }

    .group-header {
      cursor: pointer;
      font-weight: bold;
      padding: 1rem 1.5rem;
      background: #f5f5f5;
      border-radius: 0.5rem 0.5rem 0 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background-color 0.2s;
    }

    .group-header:hover {
      background: #eeeeee;
    }

    .group-content {
      padding: 1rem;
    }

    .line {
      display: flex;
      justify-content: space-between;
      align-items: stretch;
      padding: 1rem;
      margin: 0.5rem 0;
      border: 1px solid #e0e0e0;
      border-radius: 0.5rem;
      background-color: white;
      transition: background-color 0.2s;
      position: relative;
    }

    .line:hover {
      background-color: #f8f9fa;
      border-color: #d0d0d0;
    }

    .line.urgent {
      border: 2px solid #ff3860;
      background: linear-gradient(135deg, rgba(255, 56, 96, 0.05) 0%, rgba(255, 255, 255, 1) 100%);
    }

    .urgent-watermark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-15deg);
      font-size: 2rem;
      color: rgba(255, 56, 96, 0.1);
      font-weight: bold;
      pointer-events: none;
      user-select: none;
      z-index: 0;
    }

    .line-content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      position: relative;
      z-index: 1;
    }

    .grid-row {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 0.8rem;
      align-items: center;
    }

    .label-col {
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      color: #4a4a4a;
      font-size: 0.9rem;
    }

    .label-col:hover {
      color: #3273dc;
    }

    .value-col {
      color: #363636;
      word-wrap: break-word;
      line-height: 1.4;
    }

    .delete-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #ffebee;
      border: none;
      border-radius: 0 0.5rem 0.5rem 0;
      cursor: pointer;
      padding: 0 1rem;
      transition: background-color 0.2s ease;
      color: #c62828;
    }

    .delete-btn:hover {
      background-color: #ffcdd2;
    }

    .badge {
      font-weight: bold;
      padding: 0.2rem 0.6rem;
      border-radius: 1rem;
      font-size: 0.8rem;
      white-space: nowrap;
    }

    .badge.terminé {
      background-color: #d1fae5;
      color: #065f46;
    }

    .badge.enattente {
      background-color: #fee2e2;
      color: #991b1b;
    }

    .badge.envalidation {
      background-color: #ffcc80;
      color: #f57f17;
    }

    .badge.enrevue {
      background-color: #fef9c3;
      color: #92400e;
    }

    .badge.encours {
      background-color: #bfdbfe;
      color: #1e40af;
    }

    .badge.adémarrer {
      background-color: #e5e7eb;
      color: #374151;
    }

    .badge.faite {
      background-color: #d1fae5;
      color: #065f46;
    }

    .badge.afaire {
      background-color: #e5e7eb;
      color: #374151;
    }

    .arrow {
      transition: transform 0.2s ease;
    }

    .group.is-collapsed .arrow {
      transform: rotate(-90deg);
    }

    .task-selector {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #dbdbdb;
      border-radius: 0.375rem;
      background: white;
    }

    .task-item {
      padding: 0.75rem;
      border-bottom: 1px solid #f5f5f5;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .task-item:hover {
      background-color: #f8f9fa;
    }

    .task-item:last-child {
      border-bottom: none;
    }

    .task-item.selected {
      background-color: #e3f2fd;
      border-left: 3px solid #2196f3;
    }

    .task-preview {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <!-- Navbar fixe -->
  <nav class="navbar is-dark is-fixed-top" role="navigation">
    <div class="navbar-brand">
      <!--<a class="navbar-item" href="#" onclick="window.location.reload()">-->
      <a class="navbar-item" href="dailyr.html">
        <strong>DailyR</strong>
      </a>
    </div>

    <div class="navbar-menu">
      <div class="navbar-start">
        <a class="navbar-item" href="index.html">
          <span class="icon"><i class="fas fa-tasks"></i></span>
          <span>OrdeT</span>
        </a>
      </div>

      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">
            <span class="icon"><i class="fas fa-plus"></i></span>
            <span>Ajouter</span>
          </a>
          <div class="navbar-dropdown">
            <a class="navbar-item" id="navbar-add-entry">
              <span class="icon"><i class="fas fa-plus-circle"></i></span>
              <span>Nouvel Élément</span>
            </a>
            <hr class="navbar-divider">
            <a class="navbar-item" id="navbar-add-from-task">
              <span class="icon"><i class="fas fa-link"></i></span>
              <span>Depuis Tâche Existante</span>
            </a>
          </div>
        </div>

        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">
            <span class="icon"><i class="fas fa-cog"></i></span>
            <span>Données</span>
          </a>
          <div class="navbar-dropdown">
            <a class="navbar-item" id="navbar-jira-url">
              <span class="icon"><i class="fas"></i></span>
              <span>URL Jira</span>
            </a>
            <a class="navbar-item" id="navbar-export">
              <span class="icon"><i class="fas fa-download"></i></span>
              <span>Exporter</span>
            </a>
            <label class="navbar-item" for="navbar-import-file">
              <span class="icon"><i class="fas fa-upload"></i></span>
              <span>Importer</span>
              <input type="file" id="navbar-import-file" accept="application/json" style="display: none;">
            </label>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <main class="container is-fluid">
    <section class="group">
      <div class="group-header">
        <span class="arrow">▼</span>
        <span class="icon"><i class="fas fa-check-circle has-text-success"></i></span>
        <span>Ce que j'ai fait</span>
      </div>
      <div class="group-content" id="fait-container"></div>
    </section>

    <section class="group">
      <div class="group-header">
        <span class="arrow">▼</span>
        <span class="icon"><i class="fas fa-clock has-text-warning"></i></span>
        <span>Ce que je vais faire</span>
      </div>
      <div class="group-content" id="afaire-container"></div>
    </section>

    <section class="group">
      <div class="group-header">
        <span class="arrow">▼</span>
        <span class="icon"><i class="fas fa-sticky-note has-text-info"></i></span>
        <span>Notes libres</span>
      </div>
      <div class="group-content" id="notes-container"></div>
    </section>
  </main>

  <!-- Modal pour nouvel élément -->
  <div class="modal" id="modal-entry">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Ajouter / Modifier un élément</p>
        <button class="delete modal-close"></button>
      </header>
      <section class="modal-card-body">
        <form id="form-entry">
          <div class="field">
            <label class="label">Section</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select name="section" required>
                  <option value="fait">Ce que j'ai fait</option>
                  <option value="afaire">Ce que je vais faire</option>
                  <option value="notes">Notes libres</option>
                </select>
              </div>
            </div>
          </div>

          <div class="field">
            <label class="label">Référence sujet</label>
            <div class="control">
              <input class="input" type="text" name="reference">
            </div>
            <p class="help">Référence Jira ou autre identifiant</p>
          </div>

          <div class="field">
            <label class="label">Description</label>
            <div class="control">
              <input class="input" type="text" name="description" required>
            </div>
          </div>

          <div class="field">
            <label class="label">Commentaire</label>
            <div class="control">
              <textarea class="textarea" name="commentaire" rows="3"></textarea>
            </div>
          </div>

          <div class="field">
            <div class="control">
              <label class="checkbox">
                <input type="checkbox" name="urgent">
                Marquer comme urgent
              </label>
            </div>
          </div>
        </form>
      </section>
      <footer class="modal-card-foot">
        <button class="button is-success" type="submit" form="form-entry">Valider</button>
        <button class="button modal-close">Annuler</button>
      </footer>
    </div>
  </div>

  <!-- Modal pour sélectionner une tâche existante -->
  <div class="modal" id="modal-task-selector">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Sélectionner une tâche existante</p>
        <button class="delete modal-close"></button>
      </header>
      <section class="modal-card-body">
        <div class="field">
          <label class="label">Rechercher</label>
          <div class="control has-icons-left">
            <input class="input" type="text" id="task-search" placeholder="Rechercher une tâche...">
            <span class="icon is-small is-left">
              <i class="fas fa-search"></i>
            </span>
          </div>
        </div>

        <div class="field">
          <label class="label">Section de destination</label>
          <div class="control">
            <div class="select is-fullwidth">
              <select id="target-section">
                <option value="fait">Ce que j'ai fait</option>
                <option value="afaire">Ce que je vais faire</option>
                <option value="notes">Notes libres</option>
              </select>
            </div>
          </div>
        </div>

        <div class="task-selector" id="task-list"></div>
      </section>
      <footer class="modal-card-foot">
        <button class="button is-success" id="add-selected-task" disabled>Ajouter la tâche sélectionnée</button>
        <button class="button modal-close">Annuler</button>
      </footer>
    </div>
  </div>

  <!-- Modal de confirmation de suppression -->
  <div class="modal" id="modal-confirm-delete">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Confirmation</p>
        <button class="delete modal-close"></button>
      </header>
      <section class="modal-card-body">
        <p>Voulez-vous vraiment supprimer cet élément ?</p>
      </section>
      <footer class="modal-card-foot">
        <button class="button is-danger" id="confirm-delete-btn">Oui, supprimer</button>
        <button class="button modal-close">Non, annuler</button>
      </footer>
    </div>
  </div>

  <!-- Modal de définition de l'URL pour Jira -->
  <div class="modal" id="modal-set-jira-url">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Définition de l'URL Jira</p>
        <button class="modal-close"></button>
      </header>
      <section class="modal-card-body">
        <div class="field">
          <label class="label">URL vers le projet Jira</label>
          <div class="control">
            <input class="input" type="text" name="jira-url" id="jira-url-id">
          </div>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button class="button is-success" id="set-jira-url">Valider</button>
        <button class="button modal-close">Annuler</button>
    </footer>
    </div>
  </div>

  <script>
    // Variables globales
    let editingItem = null;
    let editingSection = null;
    let contextEntryMeta = null;
    let selectedTask = null;

    const storage = window.unifiedStorage;

    // Gestion des modals
    function initModals() {
      document.querySelectorAll('.modal-background, .modal-close').forEach(el => {
        el.addEventListener('click', () => {
          el.closest('.modal').classList.remove('is-active');
        });
      });
    }

    function showModal(modalId) {
      document.getElementById(modalId).classList.add('is-active');
    }

    function hideModal(modalId) {
      document.getElementById(modalId).classList.remove('is-active');
    }

    // Rendu des données
    function renderAll() {
      for (const section of ["fait", "afaire", "notes"]) {
        const container = document.getElementById(`${section}-container`);
        container.innerHTML = "";

        storage.data.dailyEntries[section]
          .sort((a, b) => new Date(a.date_ajout) - new Date(b.date_ajout))
          .forEach(item => {
            const line = document.createElement("div");
            line.className = "line";
            if (item.urgent) line.classList.add("urgent");

            const content = document.createElement("div");
            content.className = "line-content";

            const handleEdit = () => {
              editingItem = item;
              editingSection = section;
              const form = document.getElementById("form-entry");
              form.section.value = section;
              form.reference.value = item.reference || '';
              form.description.value = item.description || '';
              form.commentaire.value = item.commentaire || '';
              form.urgent.checked = item.urgent || false;
              showModal("modal-entry");
            };

            // Référence
            if (item.reference) {
              const refRow = document.createElement("div");
              refRow.className = "grid-row";
              const refLabel = document.createElement("div");
              refLabel.className = "label-col";
              refLabel.textContent = "Référence :";
              refLabel.onclick = handleEdit;
              const refValue = document.createElement("div");
              refValue.className = "value-col has-text-weight-semibold";
              refValue.textContent = item.reference;
              refRow.appendChild(refLabel);
              refRow.appendChild(refValue);
              content.appendChild(refRow);
            }

            // Statut (si c'est lié à une tâche)
            if (item.linkedTaskId) {
              const task = storage.getAllTasks().find(t => t.id === item.linkedTaskId);
              if (task) {
                const statusRow = document.createElement("div");
                statusRow.className = "grid-row";
                const statusLabel = document.createElement("div");
                statusLabel.className = "label-col";
                statusLabel.textContent = "Statut :";
                statusLabel.onclick = handleEdit;
                const statusValue = document.createElement("div");
                statusValue.className = "value-col";
                
                const badge = document.createElement("span");
                let badgeClass = task.statut.replace(/\s+/g, '').toLowerCase();
                badge.className = `badge ${badgeClass}`;
                badge.textContent = task.statut;
                statusValue.appendChild(badge);
                
                statusRow.appendChild(statusLabel);
                statusRow.appendChild(statusValue);
                content.appendChild(statusRow);
              }
            }

            // Description
            const descRow = document.createElement("div");
            descRow.className = "grid-row";
            const descLabel = document.createElement("div");
            descLabel.className = "label-col";
            descLabel.textContent = "Description :";
            descLabel.onclick = handleEdit;
            const descValue = document.createElement("div");
            descValue.className = "value-col";
            descValue.textContent = item.description || '-';
            descRow.appendChild(descLabel);
            descRow.appendChild(descValue);
            content.appendChild(descRow);

            // Commentaire
            if (item.commentaire) {
              const comRow = document.createElement("div");
              comRow.className = "grid-row";
              const comLabel = document.createElement("div");
              comLabel.className = "label-col";
              comLabel.textContent = "Commentaire :";
              comLabel.onclick = handleEdit;
              const comValue = document.createElement("div");
              comValue.className = "value-col has-text-grey";
              comValue.textContent = item.commentaire;
              comRow.appendChild(comLabel);
              comRow.appendChild(comValue);
              content.appendChild(comRow);
            }

            line.appendChild(content);

            // Bouton de suppression
            const deleteBtn = document.createElement("button");
            deleteBtn.className = "delete-btn";
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.onclick = () => {
              contextEntryMeta = { section, id: item.id };
              showModal("modal-confirm-delete");
            };
            line.appendChild(deleteBtn);

            // Filigrane urgent
            if (item.urgent) {
              const watermark = document.createElement("div");
              watermark.className = "urgent-watermark";
              watermark.textContent = "URGENT";
              line.appendChild(watermark);
            }

            container.appendChild(line);
          });
      }
    }

    // Affichage des tâches disponibles
    function renderTaskSelector(filter = '') {
      const container = document.getElementById('task-list');
      container.innerHTML = '';

      const items = filter 
        ? storage.searchAll(filter) 
        : storage.getAllTasks();

      items.forEach(item => {
        const taskItem = document.createElement('div');
        taskItem.className = 'task-item';
        taskItem.onclick = () => selectTask(item, taskItem);

        const preview = document.createElement('div');
        preview.className = 'task-preview';

        // Badge pour statut si existant
        if (item.statut) {
          const badge = document.createElement('span');
          let badgeClass = item.statut.replace(/\s+/g, '').toLowerCase();
          badge.className = `badge ${badgeClass}`;
          badge.textContent = item.statut;
          preview.appendChild(badge);
        }

        const ref = item.jira || item.reference || 'Sans référence';
        const desc = item.resume || item.description || '-';
        const commentaire = item.commentaire || 'Pas de commentaire';
        const source = item.source || 'daily';

        const info = document.createElement('div');
        info.innerHTML = `
          <div><strong>${ref}</strong> - ${desc}</div>
          <div class="has-text-grey is-size-7">${commentaire}</div>
          <div class="has-text-grey is-size-7"><em>Source: ${source}</em></div>
        `;
        preview.appendChild(info);
        taskItem.appendChild(preview);

        container.appendChild(taskItem);
      });
    }

    function selectTask(task, element) {
      // Désélectionner l'ancien élément
      document.querySelectorAll('.task-item.selected').forEach(el => {
        el.classList.remove('selected');
      });

      // Sélectionner le nouveau
      element.classList.add('selected');
      selectedTask = task;
      document.getElementById('add-selected-task').disabled = false;
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      initModals();
      renderAll();

      // Headers des groupes (collapse/expand)
      document.querySelectorAll(".group-header").forEach(header => {
        header.onclick = () => {
          const group = header.parentElement;
          group.classList.toggle("is-collapsed");
        };
      });

      // Actions de la navbar
      document.getElementById('navbar-add-entry').onclick = () => {
        editingItem = null;
        editingSection = null;
        document.getElementById("form-entry").reset();
        showModal("modal-entry");
      };

      document.getElementById('navbar-add-from-task').onclick = () => {
        selectedTask = null;
        document.getElementById('task-search').value = '';
        document.getElementById('add-selected-task').disabled = true;
        renderTaskSelector();
        showModal("modal-task-selector");
      };

      document.getElementById('navbar-jira-url').onclick = () => {
        document.getElementById("jira-url-id").value = storage.getUrl();
        showModal("modal-set-jira-url");
      };

      document.getElementById('navbar-export').onclick = () => {
        storage.exportData();
      };

      document.getElementById('navbar-import-file').onchange = (e) => {
        if (e.target.files[0]) {
          storage.importData(e.target.files[0]);
        }
      };

      // Recherche dans les tâches
      document.getElementById('task-search').oninput = (e) => {
        renderTaskSelector(e.target.value);
        selectedTask = null;
        document.getElementById('add-selected-task').disabled = true;
      };

      // Ajouter une tâche sélectionnée
      document.getElementById('add-selected-task').onclick = () => {
        if (!selectedTask) return;
        
        const section = document.getElementById('target-section').value;
        const entry = {
          reference: selectedTask.jira,
          description: selectedTask.resume,
          commentaire: selectedTask.commentaire || '',
          linkedTaskId: selectedTask.id,
          urgent: false
        };

        storage.addDailyEntry(section, entry);
        renderAll();
        hideModal("modal-task-selector");
      };

      // Définir l'URL du projet Jira
      const btn = document.getElementById('set-jira-url');
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const url = document.getElementById("jira-url-id").value;
        storage.setUrl(url);
        hideModal("modal-set-jira-url");
      });

      // Formulaire principal
      document.getElementById("form-entry").onsubmit = (e) => {
        e.preventDefault();
        const form = new FormData(e.target);
        const newSection = form.get("section");
        const entry = {
          reference: form.get("reference") || "",
          description: form.get("description") || "",
          commentaire: form.get("commentaire") || "",
          urgent: form.get("urgent") === "on"
        };

        if (editingItem && editingSection) {
          storage.updateDailyEntry(editingSection, editingItem.id, newSection, entry);
        } else {
          storage.addDailyEntry(newSection, entry);
        }

        editingItem = null;
        editingSection = null;
        renderAll();
        hideModal("modal-entry");
      };

      // Confirmation de suppression
      document.getElementById("confirm-delete-btn").onclick = () => {
        if (!contextEntryMeta) return;
        const { section, id } = contextEntryMeta;
        storage.deleteDailyEntry(section, id);
        renderAll();
        hideModal("modal-confirm-delete");
        contextEntryMeta = null;
      };

      // Burger menu pour mobile
      const burger = document.querySelector('.navbar-burger');
      const menu = document.querySelector('.navbar-menu');
      
      if (burger) {
        burger.addEventListener('click', () => {
          burger.classList.toggle('is-active');
          menu.classList.toggle('is-active');
        });
      }
    });
  </script>
</body>
</html>
